reference code from http://cpp.wesc.webfactional.com/cpp3ev2/
